{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}
 
{% block content %}
<style>
    :root {
        --glow-cyan: #00cfff;
        --glow-blue: #007bff;
        --dark-bg: #010409;
        --card-bg: #0d1117;
        --border-color: rgba(0, 199, 255, 0.15);
        --gradient-start: rgba(13, 110, 253, 0.1);
        --gradient-end: rgba(13, 17, 23, 0);
    }

    .stat-card {
        background: radial-gradient(circle at top left, var(--gradient-start), var(--gradient-end)), var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        color: #fff;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 20px rgba(0, 199, 255, 0.5), 0 0 35px rgba(0, 123, 255, 0.3);
    }
    .stat-card .card-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .stat-card .metric {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
        color: var(--glow-cyan);
        text-shadow: 0 0 8px rgba(0, 199, 255, 0.7);
    }
    .stat-card .change {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }
    .chart-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        border-radius: 0.75rem;
        height: 100%;
    }
    .map-container {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        min-height: 350px; /* Adjusted height for the map */
        color: rgba(255, 255, 255, 0.5);
        overflow: hidden;
        position: relative;
    }
    .map-container svg {
        width: 100%;
        height: auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.7;
    }
    .map-container .map-title {
        position: relative;
        z-index: 1;
        text-shadow: 0 0 10px black;
    }
    .map-container .map-dot {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { r: 4; opacity: 1; }
        50% { r: 8; opacity: 0.5; }
        100% { r: 4; opacity: 1; }
    }
</style>
 
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>
 
<!-- Alertas de Estoque Baixo (Apenas para Admins) -->
{% if g.user['role'] == 'admin' and low_stock_categories %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Alerta de Estoque Baixo!</h4>
            <p>As seguintes categorias estão com o número de itens livres abaixo do mínimo definido:</p>
            <ul>
                {% for cat in low_stock_categories %}
                <li>
                    <strong>{{ cat.category }}</strong>: {{ cat.available_items }} de {{ cat.min_stock_level }} itens livres.
                </li>
                {% endfor %}
            </ul>
            <hr>
            <a href="{{ url_for('manage_stock_levels') }}" class="btn btn-warning fw-bold">
                <i class="bi bi-graph-down-arrow"></i> Gerenciar Níveis de Estoque
            </a>
        </div>
    </div>
</div>
{% endif %}
 
<!-- Stat Cards -->
<div class="row g-4 mb-4">
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="card-title">Total de Itens</div>
            <div class="metric">{{ total_items }}</div>
            <div class="change">
                <span class="text-success"><i class="bi bi-plus-circle"></i> {{ new_items_current_month }}</span>
                este mês
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="card-title">Itens com Avaria</div>
            <div class="metric">{{ broken_items_count }}</div>
            <div class="change">
                <span class="text-danger">{{ broken_items_percentage }}%</span>
                do total
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="card-title">Novos Itens (Mês)</div>
            <div class="metric">{{ new_items_current_month }}</div>
            <div class="change {% if new_items_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                <i class="bi {% if new_items_change >= 0 %}bi-arrow-up{% else %}bi-arrow-down{% endif %}"></i>
                {{ new_items_change }}% vs mês anterior
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="card-title">Categorias Ativas</div>
            <div class="metric">{{ total_categories }}</div>
            <div class="change">
                &nbsp; <!-- Placeholder for consistent height -->
            </div>
        </div>
    </div>
</div>
 
<!-- Gráficos -->
<div class="row g-4">
    <!-- Gráfico de Linha -->
    <div class="col-xl-8">
        <div class="chart-container">
            <canvas id="monthlyItemsChart"></canvas>
        </div>
    </div>
    <!-- Gráfico de Rosca -->
    <div class="col-xl-4">
        <div class="chart-container">
            <canvas id="availabilityDonutChart"></canvas>
        </div>
    </div>
    <!-- Gráficos de Barra e Mapa -->
    <div class="col-lg-4">
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="chart-container">
            <canvas id="locationChart"></canvas>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="chart-container map-container">
            <svg viewBox="0 0 1000 500">
                <!-- Mapa Base -->
                <path d="M998 252... (caminho SVG do mapa-múndi - muito longo para exibir aqui, mas o código completo o terá)" fill="#0d1117" stroke="rgba(0,199,255,0.3)" stroke-width="1"/>
                <!-- Grade -->
                <defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(0,123,255,0.1)" stroke-width="0.5"/></pattern></defs>
                <rect width="1000" height="500" fill="url(#grid)" />
                <!-- Marcadores Brilhantes -->
                <circle class="map-dot" cx="200" cy="200" r="4" fill="var(--glow-cyan)" style="animation-delay: 0s;"/>
                <circle class="map-dot" cx="750" cy="150" r="4" fill="var(--glow-cyan)" style="animation-delay: 0.5s;"/>
                <circle class="map-dot" cx="450" cy="350" r="4" fill="var(--glow-cyan)" style="animation-delay: 1s;"/>
                <circle class="map-dot" cx="550" cy="100" r="4" fill="var(--glow-cyan)" style="animation-delay: 1.5s;"/>
            </svg>
            <h5 class="mt-2 map-title">Mapa Global de Ativos</h5>
            <p class="small map-title">Visualização de dados geoespaciais</p>
        </div>
    </div>
</div>
 
<!-- Inclui a biblioteca Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Configurações globais para os gráficos no tema escuro
    Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
 
    // Gráfico de Linha de Itens por Mês
    const monthlyCtx = document.getElementById('monthlyItemsChart').getContext('2d');
    const monthlyGradient = monthlyCtx.createLinearGradient(0, 0, 0, 400);
    monthlyGradient.addColorStop(0, 'rgba(0, 199, 255, 0.5)');
    monthlyGradient.addColorStop(1, 'rgba(13, 110, 253, 0.05)');
 
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|tojson }},
            datasets: [{
                label: 'Itens Adicionados',
                data: {{ monthly_data|tojson }},
                fill: true,
                backgroundColor: monthlyGradient, 
                borderColor: 'var(--glow-cyan)',
                pointBackgroundColor: '#fff',
                pointBorderColor: 'var(--glow-cyan)',
                pointRadius: 4,
                pointHoverRadius: 7,
                pointHoverBackgroundColor: 'var(--glow-cyan)',
                pointHoverBorderColor: '#fff',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 4,
                    displayColors: false
                },
                legend: { display: false },
                title: { display: true, text: 'Itens Adicionados nos Últimos 12 Meses', font: { size: 16 } }
            },
            scales: {
                y: { grid: { color: Chart.defaults.borderColor } },
                x: { grid: { display: false } }
            }
        }
    });
 
    // Gráfico de Rosca de Disponibilidade
    const availabilityCtx = document.getElementById('availabilityDonutChart').getContext('2d');
    new Chart(availabilityCtx, {
        type: 'doughnut',
        data: {
            labels: {{ availability_labels|tojson }},
            datasets: [{
                label: 'Disponibilidade',
                data: {{ availability_values|tojson }},
                backgroundColor: [
                    'rgba(20, 220, 120, 0.8)',  // Livre -> Verde
                    'rgba(255, 165, 0, 0.8)',  // Em uso -> Laranja
                    'rgba(0, 199, 255, 0.8)',  // Devolvido -> Ciano
                    'rgba(255, 80, 100, 0.8)'     // Outros -> Vermelho
                ],
                borderColor: 'var(--card-bg)',
                borderWidth: 4,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        boxWidth: 12
                    }
                },
                title: { display: true, text: 'Disponibilidade dos Itens', font: { size: 16 } },
                tooltip: { displayColors: false }
            }
        }
    });
 
    // Gráfico de Itens por Categoria
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryGradient = categoryCtx.createLinearGradient(0, 0, 400, 0);
    categoryGradient.addColorStop(0, 'rgba(0, 199, 255, 0.2)');
    categoryGradient.addColorStop(1, 'rgba(0, 199, 255, 0.8)');

    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: {{ category_labels|tojson }},
            datasets: [{
                label: 'Nº de Itens',
                data: {{ category_data|tojson }},
                backgroundColor: categoryGradient,
                borderColor: 'var(--glow-cyan)',
                borderWidth: 1,
                borderRadius: 4,
                borderWidth: 0,
                hoverBorderWidth: 2,
                hoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y', // Barras horizontais
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Itens por Categoria', font: { size: 16 } },
                tooltip: { displayColors: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
 
    // Gráfico de Itens por Localização
    const locationCtx = document.getElementById('locationChart').getContext('2d');
    const locationGradient = locationCtx.createLinearGradient(0, 100, 0, 300);
    locationGradient.addColorStop(0, 'rgba(0, 123, 255, 0.8)');
    locationGradient.addColorStop(1, 'rgba(0, 123, 255, 0.2)');

    new Chart(locationCtx, {
        type: 'bar',
        data: {
            labels: {{ location_labels|tojson }},
            datasets: [{
                label: 'Nº de Itens',
                data: {{ location_data|tojson }},
                backgroundColor: locationGradient,
                borderColor: 'var(--glow-blue)',
                borderRadius: 4,
                borderWidth: 0,
                hoverBorderWidth: 2,
                hoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Itens por Localização', font: { size: 16 } },
                tooltip: { displayColors: false }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });
});
</script>
 
{% endblock %}