{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    .stat-card {
        border-radius: 0.75rem;
        padding: 1.5rem;
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    /* Paleta de gradientes em tons de azul */
    .bg-gradient-teal { background: linear-gradient(45deg, #0d6efd, #4ea7dea1); } /* Light Blue */
    .bg-gradient-pink { background: linear-gradient(45deg, #0d6efd, #4ea7de98); } /* Dark Blue */
    .bg-gradient-purple { background: linear-gradient(45deg, #0d6efd, #4ea7de91); } /* Electric Blue */
    .bg-gradient-blue { background: linear-gradient(45deg, #0d6efd, #4ea7de9a); } /* Primary Blue */

    .stat-card .card-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.5rem;
    }
    .stat-card .metric {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .stat-card .change {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .stat-card .icon {
        font-size: 4rem;
        position: absolute;
        right: 1rem;
        bottom: -0.5rem;
        opacity: 0.07;
    }
    .chart-container {
        background-color: #2c3034; /* Um cinza um pouco mais claro que o fundo */
        padding: 1.5rem;
        border-radius: 0.75rem;
    }

    /* Custom styles for Flatpickr to match dark theme */
    #dashboardCalendar {
        background-color: #343a40; /* Darker input background */
        color: #fff; /* White text */
        border-color: #495057; /* Darker border */
    }
    #dashboardCalendar:focus {
        background-color: #343a40;
        color: #fff;
        border-color: #0dcaf0; /* Teal accent on focus */
        box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
    }
    /* Flatpickr specific overrides for better dark theme integration */
    .flatpickr-calendar {
        background-color: #2c3034; /* Same as chart-container */
        border: 1px solid #343a40;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    .flatpickr-day.selected, .flatpickr-day.selected:hover, .flatpickr-day.startRange, .flatpickr-day.startRange:hover, .flatpickr-day.endRange, .flatpickr-day.endRange:hover {
        background: linear-gradient(45deg, #0dcaf0, #0d6efd); /* Teal/Blue gradient for selected */
        border-color: #0dcaf0;
    }
    .flatpickr-day.today:not(.selected) {
        border-color: #6f42c1; /* Purple for today */
    }
    .flatpickr-day.today:not(.selected):hover {
        background-color: rgba(111, 66, 193, 0.2);
    }
    .flatpickr-day.inRange {
        background-color: rgba(13, 202, 240, 0.1);
        border-color: rgba(13, 202, 240, 0.1);
    }
    .flatpickr-day.flatpickr-disabled, .flatpickr-day.flatpickr-disabled:hover {
        color: rgba(255, 255, 255, 0.3);
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months .flatpickr-month,
    .flatpickr-current-month .flatpickr-numInputWrapper .numInput.flatpickr-year,
    .flatpickr-current-month .flatpickr-numInputWrapper .numInput.flatpickr-month {
        color: #fff;
    }
    .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month {
        color: #fff;
    }
    .flatpickr-months .flatpickr-prev-month:hover, .flatpickr-months .flatpickr-next-month:hover {
        color: #0dcaf0;
    }
    .flatpickr-weekday {
        color: rgba(255, 255, 255, 0.7);
    }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>

<!-- Alertas de Estoque Baixo (Apenas para Admins) -->
{% if g.user['role'] == 'admin' and low_stock_categories %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Alerta de Estoque Baixo!</h4>
            <p>As seguintes categorias estão com o número de itens livres abaixo do mínimo definido:</p>
            <ul>
                {% for cat in low_stock_categories %}
                <li>
                    <strong>{{ cat.category }}</strong>: {{ cat.available_items }} de {{ cat.min_stock_level }} itens livres.
                </li>
                {% endfor %}
            </ul>
            <hr>
            <a href="{{ url_for('manage_stock_levels') }}" class="btn btn-warning fw-bold">
                <i class="bi bi-graph-down-arrow"></i> Gerenciar Níveis de Estoque
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Stat Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="stat-card bg-gradient-blue">
            <div class="card-title">Total de Itens</div>
            <div class="metric">{{ total_items }}</div>
            <div class="change">
                <span class="text-success"><i class="bi bi-plus-circle"></i> {{ new_items_current_month }}</span>
                este mês
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="stat-card bg-gradient-pink">
            <div class="card-title">Itens com Avaria</div>
            <div class="metric">{{ broken_items_count }}</div>
            <div class="change">
                <span class="text-danger">{{ broken_items_percentage }}%</span>
                do total
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="stat-card bg-gradient-purple">
            <div class="card-title">Novos Itens (Mês)</div>
            <div class="metric">{{ new_items_current_month }}</div>
            <div class="change {% if new_items_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                <i class="bi {% if new_items_change >= 0 %}bi-arrow-up{% else %}bi-arrow-down{% endif %}"></i>
                {{ new_items_change }}% vs mês anterior
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="stat-card bg-gradient-teal">
            <div class="card-title">Categorias Ativas</div>
            <div class="metric">{{ total_categories }}</div>
            <div class="change">
                &nbsp; <!-- Placeholder for consistent height -->
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row g-4">
    <!-- Gráfico de Linha -->
    <div class="col-12">
        <div class="chart-container">
            <canvas id="monthlyItemsChart"></canvas>
        </div>
    </div>
    <!-- Gráficos de Barra -->
    <div class="col-lg-6">
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container">
            <canvas id="locationChart"></canvas>
        </div>
    </div>
</div>

<!-- Inclui a biblioteca Chart.js -->
<!-- Adiciona os arquivos JS do Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Configurações globais para os gráficos no tema escuro
    Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';

    // Função para criar gradientes para os gráficos
    function createGradient(ctx, colorStart, colorEnd) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, colorStart);
        gradient.addColorStop(1, colorEnd);
        return gradient;
    }

    // Gráfico de Linha de Itens por Mês
    const monthlyCtx = document.getElementById('monthlyItemsChart').getContext('2d');
    const monthlyGradient = createGradient(monthlyCtx, 'rgba(13, 110, 253, 0.4)', 'rgba(13, 202, 240, 0.05)');

    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|tojson }},
            datasets: [{
                label: 'Itens Adicionados',
                data: {{ monthly_data|tojson }},
                fill: true,
                backgroundColor: monthlyGradient,
                borderColor: '#0dcaf0', // Teal line
                pointBackgroundColor: '#fff',
                pointBorderColor: '#0dcaf0',
                pointRadius: 4, // Make points slightly more prominent
                pointHoverRadius: 7, // Enlarge points on hover
                pointHoverBackgroundColor: '#0dcaf0', // Fill point with color on hover
                pointHoverBorderColor: '#fff', // White border on hover
                tension: 0.4 // A slightly more gentle curve
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 4,
                    displayColors: false
                },
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Itens Adicionados nos Últimos 12 Meses',
                    font: { size: 16 }
                }
            },
            scales: {
                // ... existing scales ...
                y: { grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                x: { grid: { display: false } }
            }
        }
    });

    // Gráfico de Itens por Categoria
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryGradient = createGradient(categoryCtx, 'rgba(32, 201, 151, 0.7)', 'rgba(23, 162, 184, 0.7)');

    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: {{ category_labels|tojson }},
            datasets: [{
                label: 'Nº de Itens',
                data: {{ category_data|tojson }},
                backgroundColor: categoryGradient,
                borderRadius: 4, // Add rounded corners for a softer look
                borderWidth: 0,
                hoverBorderWidth: 2,
                hoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 4,
                    displayColors: false
                },
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Top 10 Categorias de Itens',
                    font: { size: 16 }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Gráfico de Itens por Localização
    const locationCtx = document.getElementById('locationChart').getContext('2d');
    const locationGradient = createGradient(locationCtx, 'rgba(214, 51, 132, 0.7)', 'rgba(111, 66, 193, 0.7)');

    new Chart(locationCtx, {
        type: 'bar',
        data: {
            labels: {{ location_labels|tojson }},
            datasets: [{
                label: 'Nº de Itens',
                data: {{ location_data|tojson }},
                backgroundColor: locationGradient,
                borderRadius: 4, // Add rounded corners for a softer look
                borderWidth: 0,
                hoverBorderWidth: 2,
                hoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y', // Transforma em gráfico de barras horizontais
            plugins: {
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 4,
                    displayColors: false
                },
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Top 10 Localizações de Itens',
                    font: { size: 16 }
                }
            },
            scales: { 
                x: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });
});
</script>
{% endblock %}